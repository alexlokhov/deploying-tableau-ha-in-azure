## Guide for deploying Tableau in HA configuration in Azure
### Introduction
This informal document describes patterns for implementing a Disaster Recovery (DR) program for Tableau Server on the Microsoft Azure Cloud Computing platform. It also details how Tableau's existing [high availability (HA) guidance](https://onlinehelp.tableau.com/v10.0/server/en-us/help.htm#distrib_ha_intro.htm) can be modified and augmented by Azure's services.

Although the terms high availability and disaster recovery are often used interchangeably, they are two distinct concepts. It is assumed the reader understands the differences and distinctions between HA and DR in relation to an enterprise application. They will not be discussed in depth here.

That said, a brief summary of applicable concepts and definitions can be found below:

- High Availability

   High availability describes a system’s ability to continue processing and functioning for a certain period of time. Availability is normally measured by uptime or downtime. For instance, an uptime of 99.99% represents a system that is only down for, on average, 4 minutes and 23 seconds a month.

   High availability can be implemented in your IT infrastructure by reducing any single points-of-failure (SPOF), using redundant components. Similarly, clustering and coupling applications between two or more systems can provide a highly available computing environment.

   Tableau’s high availability features seek to mitigate failure at the worker (node) and process level.
   
   High Availability comes at a cost and it is important to understand if Tableau Server should be considered a mission-critical application before making HA a mandatory requirement.

- Disaster Recovery

   Disaster Recovery focuses on business continuity after one or more major failures renders a data center or Tableau server offline. DR typically focuses on two key objectives:

   *Recovery Time Objective (RTO)* The Recovery Time Objective is the time needed to recover from a disaster or, saying it another way, how long you can afford to be without your systems.

   *Recovery Point Objective (RPO)* Recovery Point Objective describes the age of the data you want the ability to restore in the event of a disaster. For example, if your RPO is six hours, you want to be able to restore systems back to the state they were in, as of no longer than six hours ago. To achieve this, you need to be making backups or other data copies at least every six hours. Any data created or modified inside your recovery point objective will be either lost or must be recreated during a recovery.

###Tableau DR Configuration in Azure

Depending on the required RPO and RTO, a single node system with a regular backup policy and a ‘cold’ stand-by Tableau Server might be sufficient.

Tableau recommends taking periodic backups of Tableau Server for disaster recovery and business continuity needs. The backup window is also a good time to trim “stale” Tableau Server logs which are no longer useful.

Only backups made with the tabadmin backup command are supported when restoring Tableau Server. Database backups generated by other mechanisms, including Azure virtual machine snapshots are not valid sources for restoring Tableau Server.

![image](https://cloud.githubusercontent.com/assets/9513594/18582965/ce61ec02-7bff-11e6-83e6-7c0ac49c9620.png)

*Tableau Server backup architecture – the stand-by server is manually restored from backup in a failover scenario. This is a non-HA configuration.*

There is no need to stop production Tableau Server to create backups. This means that backups can be taken at frequent intervals which would reduce RPO. For example, if backups are created twice a day, up to 12 hours’ worth of data might be lost in the case the data is restored from the most recent backups (RPO = 12 hours). The recovery process is manual and it can take several hours for a server to be restored.

###Tableau HA Configuration in Azure
####Tableau Highly Available Configuration
Per Tableau’s requirements, a Tableau Server must have at least three nodes in the cluster to be considered “highly available”. A three-node cluster is a great starting point for larger deployments. Should one node fail, there will still be a quorum with the remaining active two nodes.

When using three or more nodes, deploying an odd number of nodes in a cluster is a preferred topology for improved high availability. Clusters with an even node count have the same quorum ability as clusters with one fewer node. For example, clusters with both three and four nodes will shut down in the case of two simultaneous node outages due to lack of quorum. Adding an even node to a three-node cluster will spread the workload across more nodes but also reduce the risk of complete node failure by providing additional redundant processes. If you are short on hardware resources, you can opt for the three-node HA.

####Microsoft Azure Availability Sets
To provide redundancy to Tableau Server, we recommend grouping three or more Tableau Server nodes in an availability set. This configuration ensures that during either a planned or unplanned maintenance event, at least one node will be available and meet the 99.95% Azure SLA. For more information, see the Azure SLA for Virtual Machines. Each virtual machine in an availability set is assigned an update domain and a fault domain by the underlying Azure platform. For a given availability set, five non-user-configurable update domains are assigned by default (resource manager deployments can then be increased to provide up to twenty update domains) to indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. When more than five virtual machines are configured within a single availability set, the sixth virtual machine will be placed into the same update domain as the first virtual machine, the seventh in the same update domain as the second virtual machine, and so on. The order of update domains being rebooted may not proceed sequentially during planned maintenance, but only one update domain will be rebooted at a time.

![image](https://cloud.githubusercontent.com/assets/9513594/18582905/5ca90a00-7bff-11e6-923f-28487a400803.png)

*Configuring Azure VM as a member of an availability set*

Microsoft recommends configuring separate availability sets for each application tier. Tableau Server is a single-tier application and there is no need to segregate it into multiple Availability Sets. We would recommend not to add any other applications to the same Availability Set

![image](https://cloud.githubusercontent.com/assets/9513594/18583016/17971b9a-7c00-11e6-8c5d-c235590db344.png)

*A three node HA cluster configuration*

The key to Tableau Server high availability is to have multiple nodes in a Tableau Server cluster and to configure more than one node to run the Gateway process.

It is recommended to configure a Gateway process on each node. This mitigates the risk of total service unavailability when failures occur.

What happens when a Gateway process fails? As mentioned previously, if no Gateway processes are running the entire Tableau Server cluster will be unavailable. If other Gateway processes remain running, requests made to those working Gateways will be processed normally. However, any requests received by the failed Gateway will continue to fail despite the presence of other functioning Gateways. Failed Gateway processes automatically restart; so as long as the computer itself is working, the Gateway process will relaunch and resume serving requests. If your risk tolerance to individual Gateway failures is very low, then placing your Tableau Server cluster behind an external load balancer (ELB) will ensure that requests only get routed to functioning Gateway processes. Even when the server is configured for high availability, Tableau still recommends taking regular backups.

###Azure Application Gateway and Azure Load Balancer
Microsoft Azure Application Gateway provides an Azure-managed HTTP load-balancing solution based on layer-7 load balancing. Application Gateway works at the application layer (level 7 in the OSI network reference stack). Azure Application Gateway can be used as a load-balancer when Tableau Server is going to be accessed from public internet as it acts as a reverse-proxy server and provides additional services such as HTTPS termination.

Azure Load Balancer is a Layer 4 (TCP, UDP) load balancer that distributes incoming traffic among healthy service instances in cloud services or virtual machines defined in a load-balanced set.

###Cost Considerations

Tableau Server operates on one of two license models: user-based and core-based.

The user-based license model is restricted to the number of users authorised to use Tableau Server but it does not restrict the underlying implementation.

With the core-based license, each server license covers one production and up to two non-production environments. In the first scenario, with one primary and one stand-by server, the stand-by server is not used for production. This configuration does not require multiple active nodes and can be achieved with a single 8-core license. Since only one instance of Azure VM needs to be running at any point in time, this solution can considerably reduce cloud running costs.

With the HA configuration a minimum of 16-core license is required to run Tableau Server (the primary node doesn’t need to be licensed if it only runs Cluster Controller and Gateway services). At least three VMs need to be deployed in Azure to support a HA configuration.

###Additional Resources

Tableau Server 9.0 High Availability: Delivering Mission-Critical Analytics in the Flow

http://www.tableau.com/learn/whitepapers/high-availability-mission-critical-rapid-fire-BI
